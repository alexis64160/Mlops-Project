"use strict";(self.webpackChunk_grafana_ui=self.webpackChunk_grafana_ui||[]).push([[941],{"../grafana-data/src/text/sanitize.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{G$:function(){return sanitizeTextPanelContent},sQ:function(){return textUtil}});var _braintree_sanitize_url__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/@braintree/sanitize-url/dist/index.js"),dompurify__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/dompurify/dist/purify.es.mjs"),xss__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/xss/lib/index.js");const XSSWL=Object.keys(xss__WEBPACK_IMPORTED_MODULE_2__.whiteList).reduce(((acc,element)=>(acc[element]=xss__WEBPACK_IMPORTED_MODULE_2__.whiteList[element]?.concat(["class","style"]),acc)),{});XSSWL.iframe=["src","width","height"];const sanitizeTextPanelWhitelist=new xss__WEBPACK_IMPORTED_MODULE_2__.FilterXSS({onTagAttr(tag,name,value,isWhiteAttr){if("iframe"===tag)return isWhiteAttr?` ${name}="${xss__WEBPACK_IMPORTED_MODULE_2__.escapeAttrValue(sanitizeUrl(value))}" sandbox credentialless referrerpolicy=no-referrer`:""},onTag(tag,html,options){if('<input disabled="" type="checkbox">'===html||'<input checked="" disabled="" type="checkbox">'===html)return html},whiteList:XSSWL,css:{whiteList:{...xss__WEBPACK_IMPORTED_MODULE_2__.getDefaultCSSWhiteList(),"flex-direction":!0,"flex-wrap":!0,"flex-basis":!0,"flex-grow":!0,"flex-shrink":!0,"flex-flow":!0,gap:!0,order:!0,"justify-content":!0,"justify-items":!0,"justify-self":!0,"align-items":!0,"align-content":!0,"align-self":!0}}});function sanitizeTextPanelContent(unsanitizedString){try{return sanitizeTextPanelWhitelist.process(unsanitizedString)}catch(error){return console.error("String could not be sanitized",unsanitizedString),"Text string could not be sanitized"}}function sanitizeUrl(url){return(0,_braintree_sanitize_url__WEBPACK_IMPORTED_MODULE_0__.J)(url)}function escapeHtml(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")}Error;const textUtil={escapeHtml:escapeHtml,hasAnsiCodes:function hasAnsiCodes(input){return/\u001b\[\d{1,2}m/.test(input)},sanitize:function sanitize(unsanitizedString){try{return dompurify__WEBPACK_IMPORTED_MODULE_1__.A.sanitize(unsanitizedString,{USE_PROFILES:{html:!0},FORBID_TAGS:["form","input"]})}catch(error){return console.error("String could not be sanitized",unsanitizedString),escapeHtml(unsanitizedString)}},sanitizeTextPanelContent:sanitizeTextPanelContent,sanitizeUrl:sanitizeUrl,sanitizeSVGContent:function sanitizeSVGContent(unsanitizedString){return dompurify__WEBPACK_IMPORTED_MODULE_1__.A.sanitize(unsanitizedString,{USE_PROFILES:{svg:!0,svgFilters:!0}})},sanitizeTrustedTypes:function sanitizeTrustedTypes(unsanitizedString){return dompurify__WEBPACK_IMPORTED_MODULE_1__.A.sanitize(unsanitizedString,{RETURN_TRUSTED_TYPE:!0})},sanitizeTrustedTypesRSS:function sanitizeTrustedTypesRSS(unsanitizedString){return dompurify__WEBPACK_IMPORTED_MODULE_1__.A.sanitize(unsanitizedString,{RETURN_TRUSTED_TYPE:!0,ADD_ATTR:["xmlns:atom","version","property","content"],ADD_TAGS:["rss","meta","channel","title","link","description","atom:link","item","pubDate","guid"],PARSER_MEDIA_TYPE:"application/xhtml+xml"})}}},"./src/components/QueryField/QueryField.story.tsx":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Basic:function(){return Basic},default:function(){return QueryField_story}});var jsx_runtime=__webpack_require__("../../node_modules/react/jsx-runtime.js"),emotion_css_esm=__webpack_require__("../../node_modules/@emotion/css/dist/emotion-css.esm.js"),classnames=__webpack_require__("../../node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),lodash=__webpack_require__("../../node_modules/lodash/lodash.js"),react=__webpack_require__("../../node_modules/react/index.js"),slate_plain_serializer_es=__webpack_require__("../../node_modules/slate-plain-serializer/lib/slate-plain-serializer.es.js"),slate_react_es=__webpack_require__("../../node_modules/slate-react/lib/slate-react.es.js"),selectors=__webpack_require__("../grafana-e2e-selectors/src/selectors/index.ts");const removeBom=str=>str?.replace(/[\uFEFF]/g,"");function ClipboardPlugin(){const clipboardPlugin={onCopy(event,editor,next){event.preventDefault();const{document:document,selection:selection}=editor.value,{start:{offset:startOffset},end:{offset:endOffset}}=selection,selectedBlocks=document.getLeafBlocksAtRange(selection).toArray().map((block=>block.text)),copiedText=removeBom(((textBlocks,startOffset,endOffset)=>{if(!textBlocks.length)return;const excludingLastLineLength=textBlocks.slice(0,-1).join("").length+textBlocks.length-1;return textBlocks.join("\n").slice(startOffset,excludingLastLineLength+endOffset)})(selectedBlocks,startOffset,endOffset));return copiedText&&event.clipboardData&&event.clipboardData.setData("Text",copiedText),!0},onPaste(event,editor,next){if(event.preventDefault(),event.clipboardData){const pastedValue=removeBom(event.clipboardData.getData("Text")),lines=pastedValue?.split("\n");if(lines&&lines.length){editor.insertText(lines[0]);for(const line of lines.slice(1))editor.splitBlock().insertText(line)}}return!0}};return{...clipboardPlugin,onCut(event,editor,next){return clipboardPlugin.onCopy(event,editor,next),editor.deleteAtRange(editor.value.selection),!0}}}var lib=__webpack_require__("../../node_modules/is-hotkey/lib/index.js"),slate_es=__webpack_require__("../../node_modules/slate/lib/slate.es.js");const isIndentLeftHotkey=(0,lib.Sn)("mod+["),isShiftTabHotkey=(0,lib.Sn)("shift+tab"),isIndentRightHotkey=(0,lib.Sn)("mod+]"),handleIndent=(editor,indentDirection)=>{const curSelection=editor.value.selection,selectedBlocks=editor.value.document.getLeafBlocksAtRange(curSelection).toArray();if("left"===indentDirection)for(const block of selectedBlocks){const blockWhitespace=block.text.length-block.text.trimLeft().length,textKey=block.getFirstText().key,rangeProperties={anchor:{key:textKey,offset:blockWhitespace,path:[]},focus:{key:textKey,offset:blockWhitespace,path:[]}};editor.deleteBackwardAtRange(slate_es.Q6.create(rangeProperties),Math.min(2,blockWhitespace))}else{const{startText:startText}=editor.value,textBeforeCaret=startText.text.slice(0,curSelection.start.offset),isWhiteSpace=/^\s*$/.test(textBeforeCaret);for(const block of selectedBlocks)editor.insertTextByKey(block.getFirstText().key,0,"  ");isWhiteSpace&&editor.moveStartBackward(2)}};function IndentationPlugin(){return{onKeyDown(event,editor,next){if(isIndentLeftHotkey(event)||isShiftTabHotkey(event))event.preventDefault(),handleIndent(editor,"left");else if(isIndentRightHotkey(event))event.preventDefault(),handleIndent(editor,"right");else{if("Tab"!==event.key)return next();((event,editor)=>{const{startBlock:startBlock,endBlock:endBlock,selection:{start:{offset:startOffset,key:startKey},end:{offset:endOffset,key:endKey}}}=editor.value;if(""===slate_plain_serializer_es.A.serialize(editor.value))return;event.preventDefault();const first=startBlock.getFirstText();first&&0===startOffset&&startKey===first.key&&endOffset===first.text.length&&endKey===first.key||!startBlock.equals(endBlock)?handleIndent(editor,"right"):editor.insertText("  ")})(event,editor)}return!0}}}function RunnerPlugin({handler:handler}){return{onKeyDown(event,editor,next){return handler&&"Enter"===event.key&&(event.shiftKey||event.ctrlKey)?(event.preventDefault(),handler(event),editor):next()}}}const isSelectLineHotkey=(0,lib.Sn)("mod+l");var react_dom=__webpack_require__("../../node_modules/react-dom/index.js"),index_esm=__webpack_require__("../../node_modules/react-window/dist/index.esm.js"),context=__webpack_require__("../grafana-data/src/themes/context.tsx"),CompletionItemKind=function(CompletionItemKind){return CompletionItemKind.GroupTitle="GroupTitle",CompletionItemKind}({}),calculate_size_lib=__webpack_require__("../../node_modules/calculate-size/lib/index.js");const flattenGroupItems=groupedItems=>groupedItems.reduce(((all,{items:items,label:label})=>(all.push({label:label,kind:CompletionItemKind.GroupTitle}),items.reduce(((all,item)=>(all.push(item),all)),all))),[]),calculateLongestLabel=allItems=>allItems.reduce(((longest,current)=>longest.length<current.label.length?current.label:longest),""),calculateListSizes=(theme,allItems,longestLabel)=>{const size=(0,calculate_size_lib.A)(longestLabel,{font:theme.typography.fontFamilyMonospace,fontSize:theme.typography.bodySmall.fontSize,fontWeight:"normal"}),listWidth=calculateListWidth(size.width,theme),itemHeight=calculateItemHeight(size.height,theme);return{listWidth:listWidth,listHeight:calculateListHeight(itemHeight,allItems),itemHeight:itemHeight}},calculateItemHeight=(longestLabelHeight,theme)=>longestLabelHeight+2*theme.spacing.gridSize,calculateListWidth=(longestLabelWidth,theme)=>{const verticalPadding=3*theme.spacing.gridSize;return Math.min(Math.max(longestLabelWidth+verticalPadding,200),800)},calculateListHeight=(itemHeight,allItems)=>{const totalHeight=Math.min(allItems.length,10)*itemHeight;return Math.max(totalHeight,100)};var marked_esm=__webpack_require__("../../node_modules/marked/lib/marked.esm.js"),src=__webpack_require__("../../node_modules/marked-mangle/src/index.js"),sanitize=__webpack_require__("../grafana-data/src/text/sanitize.ts");let hasInitialized=!1;const markdownOptions={pedantic:!1,gfm:!0,breaks:!1};var ThemeContext=__webpack_require__("./src/themes/ThemeContext.tsx");const TypeaheadInfo=({item:item,height:height})=>{const visible=item&&!!item.documentation,label=item?item.label:"",documentation=function renderMarkdown(str,options){let opts;hasInitialized||(marked_esm.xI.use((0,src.z)()),marked_esm.xI.setOptions({...markdownOptions}),hasInitialized=!0),options?.breaks&&(opts={...markdownOptions,breaks:!0});const html=(0,marked_esm.xI)(str||"",opts);if("string"!=typeof html)throw new Error("Failed to process markdown synchronously.");return options?.noSanitize?html:(0,sanitize.G$)(html)}(item?.documentation),styles=((theme,height,visible)=>({typeaheadItem:(0,emotion_css_esm.AH)({label:"type-ahead-item",zIndex:11,padding:theme.spacing(1,1,1,2),border:theme.colors.border.medium,overflowY:"scroll",overflowX:"hidden",outline:"none",background:theme.colors.background.secondary,color:theme.colors.text.secondary,boxShadow:`0 0 20px ${theme.v1.colors.dropdownShadow}`,visibility:!0===visible?"visible":"hidden",width:"250px",minHeight:`${height+parseInt(theme.spacing(.25),10)}px`,position:"relative",wordBreak:"break-word"})}))((0,ThemeContext.$j)(),height,visible);return(0,jsx_runtime.jsxs)("div",{className:(0,emotion_css_esm.cx)([styles.typeaheadItem]),children:[(0,jsx_runtime.jsx)("b",{children:label}),(0,jsx_runtime.jsx)("hr",{}),(0,jsx_runtime.jsx)("div",{dangerouslySetInnerHTML:{__html:documentation}})]})};try{TypeaheadInfo.displayName="TypeaheadInfo",TypeaheadInfo.__docgenInfo={description:"",displayName:"TypeaheadInfo",props:{item:{defaultValue:null,description:"",name:"item",required:!0,type:{name:"CompletionItem"}},height:{defaultValue:null,description:"",name:"height",required:!0,type:{name:"number"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/TypeaheadInfo.tsx#TypeaheadInfo"]={docgenInfo:TypeaheadInfo.__docgenInfo,name:"TypeaheadInfo",path:"src/components/Typeahead/TypeaheadInfo.tsx#TypeaheadInfo"})}catch(__react_docgen_typescript_loader_error){}var main=__webpack_require__("../../node_modules/react-highlight-words/dist/main.js"),main_default=__webpack_require__.n(main);const PartialHighlighter=props=>{let{highlightParts:highlightParts,text:text,highlightClassName:highlightClassName}=props;if(!highlightParts?.length)return null;let children=[],indices=function getStartIndices(parts,length){const indices=[];return parts.forEach((part=>{indices.push(part.start,part.end+1)})),0!==indices[0]&&indices.unshift(0),indices[indices.length-1]!==length&&indices.push(length),indices}(highlightParts,text.length),highlighted=0===highlightParts[0].start;for(let i=1;i<indices.length;i++){let start=indices[i-1],end=indices[i];children.push((0,react.createElement)(highlighted?"mark":"span",{key:i-1,className:highlighted?highlightClassName:void 0},text.substring(start,end))),highlighted=!highlighted}return(0,jsx_runtime.jsx)("div",{children:children})};try{PartialHighlighter.displayName="PartialHighlighter",PartialHighlighter.__docgenInfo={description:"",displayName:"PartialHighlighter",props:{text:{defaultValue:null,description:"",name:"text",required:!0,type:{name:"string"}},highlightParts:{defaultValue:null,description:"",name:"highlightParts",required:!0,type:{name:"HighlightPart[]"}},highlightClassName:{defaultValue:null,description:"",name:"highlightClassName",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/PartialHighlighter.tsx#PartialHighlighter"]={docgenInfo:PartialHighlighter.__docgenInfo,name:"PartialHighlighter",path:"src/components/Typeahead/PartialHighlighter.tsx#PartialHighlighter"})}catch(__react_docgen_typescript_loader_error){}const TypeaheadItem_getStyles=theme=>({typeaheadItem:(0,emotion_css_esm.AH)({border:"none",background:"none",textAlign:"left",label:"type-ahead-item",height:"auto",fontFamily:theme.typography.fontFamilyMonospace,padding:theme.spacing(1,1,1,2),fontSize:theme.typography.bodySmall.fontSize,textOverflow:"ellipsis",overflow:"hidden",zIndex:11,display:"block",whiteSpace:"nowrap",cursor:"pointer",[theme.transitions.handleMotion("no-preference","reduce")]:{transition:"color 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), border-color 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), background 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), padding 0.15s cubic-bezier(0.645, 0.045, 0.355, 1)"}}),typeaheadItemSelected:(0,emotion_css_esm.AH)({label:"type-ahead-item-selected",backgroundColor:theme.colors.background.secondary}),typeaheadItemMatch:(0,emotion_css_esm.AH)({label:"type-ahead-item-match",color:theme.v1.palette.yellow,borderBottom:`1px solid ${theme.v1.palette.yellow}`,padding:"inherit",background:"inherit"}),typeaheadItemGroupTitle:(0,emotion_css_esm.AH)({label:"type-ahead-item-group-title",color:theme.colors.text.secondary,fontSize:theme.typography.bodySmall.fontSize,lineHeight:theme.typography.body.lineHeight,padding:theme.spacing(1)})}),TypeaheadItem=props=>{const styles=(0,ThemeContext.of)(TypeaheadItem_getStyles),{isSelected:isSelected,item:item,prefix:prefix,style:style,onMouseEnter:onMouseEnter,onMouseLeave:onMouseLeave,onClickItem:onClickItem}=props,className=isSelected?(0,emotion_css_esm.cx)([styles.typeaheadItem,styles.typeaheadItemSelected]):(0,emotion_css_esm.cx)([styles.typeaheadItem]),highlightClassName=(0,emotion_css_esm.cx)([styles.typeaheadItemMatch]),itemGroupTitleClassName=(0,emotion_css_esm.cx)([styles.typeaheadItemGroupTitle]),label=item.label||"";return item.kind===CompletionItemKind.GroupTitle?(0,jsx_runtime.jsx)("li",{className:itemGroupTitleClassName,style:style,children:(0,jsx_runtime.jsx)("span",{children:label})}):(0,jsx_runtime.jsx)("li",{role:"none",children:(0,jsx_runtime.jsx)("button",{role:"menuitem",className:className,style:style,onMouseDown:onClickItem,onMouseEnter:onMouseEnter,onMouseLeave:onMouseLeave,type:"button",children:void 0!==item.highlightParts?(0,jsx_runtime.jsx)(PartialHighlighter,{text:label,highlightClassName:highlightClassName,highlightParts:item.highlightParts}):(0,jsx_runtime.jsx)(main_default(),{textToHighlight:label,searchWords:[prefix??""],autoEscape:!0,highlightClassName:highlightClassName})})})};try{TypeaheadItem.displayName="TypeaheadItem",TypeaheadItem.__docgenInfo={description:"",displayName:"TypeaheadItem",props:{isSelected:{defaultValue:null,description:"",name:"isSelected",required:!0,type:{name:"boolean"}},item:{defaultValue:null,description:"",name:"item",required:!0,type:{name:"CompletionItem"}},style:{defaultValue:null,description:"",name:"style",required:!0,type:{name:"CSSProperties"}},prefix:{defaultValue:null,description:"",name:"prefix",required:!1,type:{name:"string"}},onClickItem:{defaultValue:null,description:"",name:"onClickItem",required:!1,type:{name:"((event: MouseEvent<Element, MouseEvent>) => void)"}},onMouseEnter:{defaultValue:null,description:"",name:"onMouseEnter",required:!1,type:{name:"(() => void)"}},onMouseLeave:{defaultValue:null,description:"",name:"onMouseLeave",required:!1,type:{name:"(() => void)"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/TypeaheadItem.tsx#TypeaheadItem"]={docgenInfo:TypeaheadItem.__docgenInfo,name:"TypeaheadItem",path:"src/components/Typeahead/TypeaheadItem.tsx#TypeaheadItem"})}catch(__react_docgen_typescript_loader_error){}const modulo=(a,n)=>a-n*Math.floor(a/n);class Typeahead extends react.PureComponent{static contextType=context.D;context;listRef=(0,react.createRef)();state={hoveredItem:null,typeaheadIndex:null,allItems:[],listWidth:-1,listHeight:-1,itemHeight:-1};componentDidMount=()=>{this.props.menuRef&&this.props.menuRef(this),document.addEventListener("selectionchange",this.handleSelectionChange);const allItems=flattenGroupItems(this.props.groupedItems),longestLabel=calculateLongestLabel(allItems),{listWidth:listWidth,listHeight:listHeight,itemHeight:itemHeight}=calculateListSizes(this.context,allItems,longestLabel);this.setState({listWidth:listWidth,listHeight:listHeight,itemHeight:itemHeight,allItems:allItems})};componentWillUnmount=()=>{document.removeEventListener("selectionchange",this.handleSelectionChange)};handleSelectionChange=()=>{this.forceUpdate()};componentDidUpdate=(prevProps,prevState)=>{if(null!==this.state.typeaheadIndex&&prevState.typeaheadIndex!==this.state.typeaheadIndex&&this.listRef&&this.listRef.current){if(1===this.state.typeaheadIndex)return void this.listRef.current.scrollToItem(0);this.listRef.current.scrollToItem(this.state.typeaheadIndex)}if(!1===(0,lodash.isEqual)(prevProps.groupedItems,this.props.groupedItems)){const allItems=flattenGroupItems(this.props.groupedItems),longestLabel=calculateLongestLabel(allItems),{listWidth:listWidth,listHeight:listHeight,itemHeight:itemHeight}=calculateListSizes(this.context,allItems,longestLabel);this.setState({listWidth:listWidth,listHeight:listHeight,itemHeight:itemHeight,allItems:allItems,typeaheadIndex:null})}};onMouseEnter=index=>{this.setState({hoveredItem:index})};onMouseLeave=()=>{this.setState({hoveredItem:null})};moveMenuIndex=moveAmount=>{const itemCount=this.state.allItems.length;if(itemCount){const typeaheadIndex=this.state.typeaheadIndex||0;let newTypeaheadIndex=modulo(typeaheadIndex+moveAmount,itemCount);return this.state.allItems[newTypeaheadIndex].kind===CompletionItemKind.GroupTitle&&(newTypeaheadIndex=modulo(newTypeaheadIndex+moveAmount,itemCount)),void this.setState({typeaheadIndex:newTypeaheadIndex})}};insertSuggestion=()=>{this.props.onSelectSuggestion&&null!==this.state.typeaheadIndex&&this.props.onSelectSuggestion(this.state.allItems[this.state.typeaheadIndex])};get menuPosition(){if(!window.getSelection)return"";const selection=window.getSelection(),node=selection&&selection.anchorNode;if(node&&node.parentElement){const rect=node.parentElement.getBoundingClientRect(),scrollX=window.scrollX,scrollY=window.scrollY;return`position: absolute; display: flex; top: ${rect.top+scrollY+rect.height+6}px; left: ${rect.left+scrollX-2}px`}return""}render(){const{prefix:prefix,isOpen:isOpen=!1,origin:origin}=this.props,{allItems:allItems,listWidth:listWidth,listHeight:listHeight,itemHeight:itemHeight,hoveredItem:hoveredItem,typeaheadIndex:typeaheadIndex}=this.state,styles=Typeahead_getStyles(this.context),showDocumentation=hoveredItem||typeaheadIndex,documentationItem=allItems[hoveredItem||(typeaheadIndex||0)];return(0,jsx_runtime.jsxs)(Portal,{origin:origin,isOpen:isOpen,style:this.menuPosition,children:[(0,jsx_runtime.jsx)("ul",{role:"menu",className:styles.typeahead,"data-testid":"typeahead",children:(0,jsx_runtime.jsx)(index_esm.Y1,{ref:this.listRef,itemCount:allItems.length,itemSize:itemHeight,itemKey:index=>{const item=allItems&&allItems[index];return item?`${index}-${item.label}`:`${index}`},width:listWidth,height:listHeight,children:({index:index,style:style})=>{const item=allItems&&allItems[index];return item?(0,jsx_runtime.jsx)(TypeaheadItem,{onClickItem:()=>this.props.onSelectSuggestion?this.props.onSelectSuggestion(item):{},isSelected:null!==typeaheadIndex&&allItems[typeaheadIndex]===item,item:item,prefix:prefix,style:style,onMouseEnter:()=>this.onMouseEnter(index),onMouseLeave:this.onMouseLeave}):null}})}),showDocumentation&&(0,jsx_runtime.jsx)(TypeaheadInfo,{height:listHeight,item:documentationItem})]})}}class Portal extends react.PureComponent{node;constructor(props){super(props);const{index:index=0,origin:origin="query",style:style}=props;this.node=document.createElement("div"),this.node.setAttribute("style",style),this.node.classList.add(`slate-typeahead-${origin}-${index}`),document.body.appendChild(this.node)}componentWillUnmount(){document.body.removeChild(this.node)}render(){return this.props.isOpen?(this.node.setAttribute("style",this.props.style),this.node.classList.add("slate-typeahead--open"),react_dom.createPortal(this.props.children,this.node)):(this.node.classList.remove("slate-typeahead--open"),null)}}const Typeahead_getStyles=theme=>({typeahead:(0,emotion_css_esm.AH)({position:"relative",zIndex:theme.zIndex.typeahead,borderRadius:theme.shape.radius.default,border:`1px solid ${theme.components.panel.borderColor}`,maxHeight:"66vh",overflowY:"scroll",overflowX:"hidden",outline:"none",listStyle:"none",background:theme.components.panel.background,color:theme.colors.text.primary,boxShadow:theme.shadows.z2,strong:{color:theme.v1.palette.yellow}})});try{Typeahead.displayName="Typeahead",Typeahead.__docgenInfo={description:"",displayName:"Typeahead",props:{origin:{defaultValue:null,description:"",name:"origin",required:!0,type:{name:"string"}},groupedItems:{defaultValue:null,description:"",name:"groupedItems",required:!0,type:{name:"CompletionItemGroup[]"}},prefix:{defaultValue:null,description:"",name:"prefix",required:!1,type:{name:"string"}},menuRef:{defaultValue:null,description:"",name:"menuRef",required:!1,type:{name:"((el: Typeahead) => void)"}},onSelectSuggestion:{defaultValue:null,description:"",name:"onSelectSuggestion",required:!1,type:{name:"((suggestion: CompletionItem) => void)"}},isOpen:{defaultValue:null,description:"",name:"isOpen",required:!1,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/Typeahead.tsx#Typeahead"]={docgenInfo:Typeahead.__docgenInfo,name:"Typeahead",path:"src/components/Typeahead/Typeahead.tsx#Typeahead"})}catch(__react_docgen_typescript_loader_error){}try{contextType.displayName="Typeahead.contextType",contextType.__docgenInfo={description:"Context lets components pass information deep down without explicitly\npassing props.\n\nCreated from {@link createContext}",displayName:"Typeahead.contextType",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/Typeahead.tsx#Typeahead.contextType"]={docgenInfo:Typeahead.contextType.__docgenInfo,name:"Typeahead.contextType",path:"src/components/Typeahead/Typeahead.tsx#Typeahead.contextType"})}catch(__react_docgen_typescript_loader_error){}var SearchFunctionType=function(SearchFunctionType){return SearchFunctionType.Word="Word",SearchFunctionType.Prefix="Prefix",SearchFunctionType.Fuzzy="Fuzzy",SearchFunctionType}({});const SearchFunctionMap={Word:(items,text)=>items.filter((c=>(c.filterText||c.label).includes(text))),Prefix:(items,text)=>items.filter((c=>(c.filterText||c.label).startsWith(text))),Fuzzy:(items,text)=>(text=text.toLowerCase(),items.filter((item=>{const{distance:distance,ranges:ranges,found:found}=function fuzzyMatch(stack,needle){let distance=0,searchIndex=stack.indexOf(needle);needle=needle.replace(/\s/g,"");const ranges=[];if(-1!==searchIndex)return{distance:0,found:!0,ranges:[{start:searchIndex,end:searchIndex+needle.length-1}]};for(const letter of needle){const letterIndex=stack.indexOf(letter,searchIndex);if(-1===letterIndex)return{distance:1/0,ranges:[],found:!1};if(-1!==searchIndex&&(distance+=letterIndex-searchIndex),searchIndex=letterIndex+1,0===ranges.length)ranges.push({start:letterIndex,end:letterIndex});else{const lastRange=(0,lodash.last)(ranges);letterIndex===lastRange.end+1?lastRange.end++:ranges.push({start:letterIndex,end:letterIndex})}}return{distance:distance,ranges:ranges,found:!0}}(item.label.toLowerCase(),text);return!!found&&(item.sortValue=distance,item.highlightParts=ranges,!0)})))},SCHEMA={document:{nodes:[{match:[{type:"paragraph"},{type:"code_block"},{type:"code_line"}]}]},inlines:{}},makeFragment=(text,syntax)=>{const lines=text.split("\n").map((line=>slate_es.eB.create({type:"code_line",nodes:[slate_es.EY.create(line)]}))),block=slate_es.eB.create({data:{syntax:syntax},type:"code_block",nodes:lines});return slate_es.yo.create({nodes:[block]})},makeValue=(text,syntax)=>{const fragment=makeFragment(text,syntax);return slate_es.WT.create({document:fragment})};function SuggestionsPlugin({onTypeahead:onTypeahead,cleanText:cleanText,onWillApplySuggestion:onWillApplySuggestion,portalOrigin:portalOrigin}){let typeaheadRef,state={groupedItems:[],typeaheadPrefix:"",typeaheadContext:"",typeaheadText:""};const handleTypeaheadDebounced=(0,lodash.debounce)(handleTypeahead,250),setState=update=>{state={...state,...update}};return{onBlur:(event,editor,next)=>(state={...state,groupedItems:[]},next()),onClick:(event,editor,next)=>(state={...state,groupedItems:[]},next()),onKeyDown:(event,editor,next)=>{const hasSuggestions=state.groupedItems.length;switch(event.key){case"Escape":if(hasSuggestions)return event.preventDefault(),state={...state,groupedItems:[]},editor.insertText("");break;case"ArrowDown":case"ArrowUp":if(hasSuggestions)return event.preventDefault(),void typeaheadRef.moveMenuIndex("ArrowDown"===event.key?1:-1);break;case"Enter":if(!event.shiftKey&&!event.ctrlKey&&hasSuggestions)return event.preventDefault(),typeaheadRef.insertSuggestion();break;case"Tab":if(hasSuggestions)return event.preventDefault(),typeaheadRef.insertSuggestion();break;default:1===event.key.length&&handleTypeaheadDebounced(editor,setState,onTypeahead,cleanText)}return next()},commands:{selectSuggestion:(editor,suggestion)=>{const suggestions=state.groupedItems;if(!suggestions||!suggestions.length)return editor;const ed=editor.applyTypeahead(suggestion);return handleTypeaheadDebounced(editor,setState,onTypeahead,cleanText),ed},applyTypeahead:(editor,suggestion)=>{let suggestionText=suggestion.insertText||suggestion.label;const preserveSuffix="function"===suggestion.kind,move=suggestion.move||0,moveForward=move>0?move:0,moveBackward=move<0?-move:0,{typeaheadPrefix:typeaheadPrefix,typeaheadText:typeaheadText,typeaheadContext:typeaheadContext}=state;onWillApplySuggestion&&(suggestionText=onWillApplySuggestion(suggestionText,{groupedItems:state.groupedItems,typeaheadContext:typeaheadContext,typeaheadPrefix:typeaheadPrefix,typeaheadText:typeaheadText}));const{forward:forward,backward:backward}=function getNumCharsToDelete(suggestionText,typeaheadPrefix,typeaheadText,preserveSuffix,deleteBackwards,cleanText){const backward=deleteBackwards||typeaheadPrefix.length,text=cleanText?cleanText(typeaheadText):typeaheadText,offset=typeaheadText.indexOf(typeaheadPrefix),suffixLength=offset>-1?text.length-offset-typeaheadPrefix.length:text.length-typeaheadPrefix.length,midWord=Boolean(typeaheadPrefix&&suffixLength>0||suggestionText===typeaheadText),forward=midWord&&!preserveSuffix?suffixLength+offset:0;return{forward:forward,backward:backward}}(suggestionText,typeaheadPrefix,typeaheadText,preserveSuffix,suggestion.deleteBackwards,cleanText);if(suggestionText.match(/\n/)){const fragment=makeFragment(suggestionText);return editor.deleteBackward(backward).deleteForward(forward).insertFragment(fragment).focus(),editor}return state={...state,groupedItems:[]},editor.snapshotSelection().deleteBackward(backward).deleteForward(forward).insertText(suggestionText).moveForward(moveForward).moveBackward(moveBackward).focus(),editor}},renderEditor(props,editor,next){if(editor.value.selection.isExpanded)return next();const children=next();return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[children,(0,jsx_runtime.jsx)(Typeahead,{menuRef:menu=>typeaheadRef=menu,origin:portalOrigin,prefix:state.typeaheadPrefix,isOpen:!!state.groupedItems.length,groupedItems:state.groupedItems,onSelectSuggestion:editor.selectSuggestion})]})}}}const handleTypeahead=async(editor,onStateChange,onTypeahead,cleanText)=>{if(!onTypeahead)return;const{value:value}=editor,{selection:selection}=value,parentBlock=value.document.getClosestBlock(value.focusBlock.key),selectionStartOffset=value.selection.start.offset-1,decorations=parentBlock&&parentBlock.getDecorations(editor),filteredDecorations=decorations?decorations.filter((decoration=>decoration.start.offset<=selectionStartOffset&&decoration.end.offset>selectionStartOffset&&"prism-token"===decoration.type)).toArray():[],labelKeyDec=decorations&&decorations.filter((decoration=>decoration.end.offset<=selectionStartOffset&&"prism-token"===decoration.type&&decoration.data.get("className").includes("label-key"))).last(),labelKey=labelKeyDec&&value.focusText.text.slice(labelKeyDec.start.offset,labelKeyDec.end.offset),wrapperClasses=filteredDecorations.map((decoration=>decoration.data.get("className"))).join(" ").split(" ").filter((className=>className.length));let text=value.focusText.text,prefix=text.slice(0,selection.focus.offset);filteredDecorations.length&&(text=value.focusText.text.slice(filteredDecorations[0].start.offset,filteredDecorations[0].end.offset),prefix=value.focusText.text.slice(filteredDecorations[0].start.offset,selection.focus.offset));const labelValueMatch=prefix.match(/(?:!?=~?"?|")(.*)/);labelValueMatch?prefix=labelValueMatch[1]:cleanText&&(prefix=cleanText(prefix));const{suggestions:suggestions,context:context}=await onTypeahead({prefix:prefix,text:text,value:value,wrapperClasses:wrapperClasses,labelKey:labelKey||void 0,editor:editor});onStateChange({groupedItems:suggestions.map((group=>{if(!group.items)return group;const searchFunctionType=group.searchFunctionType||(group.prefixMatch?SearchFunctionType.Prefix:SearchFunctionType.Word),searchFunction=SearchFunctionMap[searchFunctionType];let newGroup={...group};return prefix&&(group.skipFilter||(newGroup.items=newGroup.items.filter((c=>(c.filterText||c.label).length>=prefix.length)),newGroup.items=searchFunction(newGroup.items,prefix)),newGroup.items=newGroup.items.filter((c=>!(c.insertText===prefix||(c.filterText??c.label)===prefix)))),group.skipSort||(newGroup.items=(0,lodash.sortBy)(newGroup.items,(item=>void 0===item.sortText?void 0!==item.sortValue?item.sortValue:item.label:item.sortText||item.label))),newGroup})).filter((gr=>gr.items&&gr.items.length)),typeaheadPrefix:prefix,typeaheadContext:context,typeaheadText:text}),editor.blur().focus()};try{SuggestionsPlugin.displayName="SuggestionsPlugin",SuggestionsPlugin.__docgenInfo={description:"",displayName:"SuggestionsPlugin",props:{onTypeahead:{defaultValue:null,description:"",name:"onTypeahead",required:!1,type:{name:"((typeahead: TypeaheadInput) => Promise<TypeaheadOutput>)"}},cleanText:{defaultValue:null,description:"",name:"cleanText",required:!1,type:{name:"((text: string) => string)"}},onWillApplySuggestion:{defaultValue:null,description:"",name:"onWillApplySuggestion",required:!1,type:{name:"((suggestion: string, state: SuggestionsState) => string)"}},portalOrigin:{defaultValue:null,description:"",name:"portalOrigin",required:!0,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/slate-plugins/suggestions.tsx#SuggestionsPlugin"]={docgenInfo:SuggestionsPlugin.__docgenInfo,name:"SuggestionsPlugin",path:"src/slate-plugins/suggestions.tsx#SuggestionsPlugin"})}catch(__react_docgen_typescript_loader_error){}var mixins=__webpack_require__("./src/themes/mixins.ts");class UnThemedQueryField extends react.PureComponent{plugins;runOnChangeDebounced;lastExecutedValue=null;mounted=!1;editor=null;static defaultProps={onBlur:()=>{}};constructor(props){super(props),this.runOnChangeDebounced=(0,lodash.debounce)(this.runOnChange,500);const{onTypeahead:onTypeahead,cleanText:cleanText,portalOrigin:portalOrigin,onWillApplySuggestion:onWillApplySuggestion}=props;this.plugins=[SuggestionsPlugin({onTypeahead:onTypeahead,cleanText:cleanText,portalOrigin:portalOrigin,onWillApplySuggestion:onWillApplySuggestion}),RunnerPlugin({handler:this.runOnChangeAndRunQuery}),{onKeyDown(event,editor,next){const value=editor.value;if(value.selection.isExpanded)return next();if("Enter"===event.key){event.preventDefault();const{startBlock:startBlock}=value,indent=function getIndent(text){let offset=text.length-text.trimLeft().length;if(offset){let indent=text[0];for(;--offset;)indent+=text[0];return indent}return""}(startBlock.text);return editor.splitBlock().insertText(indent).focus()}return next()}},{onKeyDown(event,editor,next){const value=editor.value;if(value.selection.isExpanded)return next();if("k"===event.key&&event.ctrlKey){event.preventDefault();const text=value.anchorText.text,offset=value.selection.anchor.offset,forward=text.length-offset;return editor.deleteForward(forward),!0}return next()}},{onKeyDown(event,editor,next){if(!isSelectLineHotkey(event))return next();{event.preventDefault();const{focusBlock:focusBlock,document:document}=editor.value;editor.moveAnchorToStartOfBlock(),document.getNextBlock(focusBlock.key)?editor.moveFocusToStartOfNextBlock():editor.moveFocusToEndOfText()}return!0}},IndentationPlugin(),ClipboardPlugin(),...props.additionalPlugins||[]].filter((p=>p)),this.state={suggestions:[],typeaheadContext:null,typeaheadPrefix:"",typeaheadText:"",value:makeValue(props.query||"",props.syntax)}}componentDidMount(){this.mounted=!0}componentWillUnmount(){this.mounted=!1}componentDidUpdate(prevProps,prevState){const{query:query,syntax:syntax,syntaxLoaded:syntaxLoaded}=this.props;if(!prevProps.syntaxLoaded&&syntaxLoaded&&this.editor){const editor=this.editor.insertText(" ").deleteBackward(1);this.onChange(editor.value,!0)}const{value:value}=this.state;query!==prevProps.query&&query!==slate_plain_serializer_es.A.serialize(value)&&this.setState({value:makeValue(query||"",syntax)})}onChange=(value,runQuery)=>{const documentChanged=value.document!==this.state.value.document,prevValue=this.state.value;this.props.onRichValueChange&&this.props.onRichValueChange(value),this.setState({value:value},(()=>{if(documentChanged){const textChanged=slate_plain_serializer_es.A.serialize(prevValue)!==slate_plain_serializer_es.A.serialize(value);textChanged&&runQuery&&this.runOnChangeAndRunQuery(),textChanged&&!runQuery&&this.runOnChangeDebounced()}}))};runOnChange=()=>{const{onChange:onChange}=this.props,value=slate_plain_serializer_es.A.serialize(this.state.value);onChange&&onChange(this.cleanText(value))};runOnRunQuery=()=>{const{onRunQuery:onRunQuery}=this.props;onRunQuery&&(onRunQuery(),this.lastExecutedValue=this.state.value)};runOnChangeAndRunQuery=()=>{this.runOnChange(),this.runOnRunQuery()};handleBlur=(_,editor,next)=>{const{onBlur:onBlur}=this.props;if(onBlur)onBlur();else{(this.lastExecutedValue?slate_plain_serializer_es.A.serialize(this.lastExecutedValue):"")!==slate_plain_serializer_es.A.serialize(editor.value)&&this.runOnChangeAndRunQuery()}return next()};cleanText(text){return text.replace(/[\r]/g,"")}render(){const{disabled:disabled,theme:theme}=this.props,wrapperClassName=classnames_default()("slate-query-field__wrapper",{"slate-query-field__wrapper--disabled":disabled}),styles=QueryField_getStyles(theme);return(0,jsx_runtime.jsx)("div",{className:(0,emotion_css_esm.cx)(wrapperClassName,styles.wrapper),children:(0,jsx_runtime.jsx)("div",{className:"slate-query-field","data-testid":selectors.Tp.components.QueryField.container,children:(0,jsx_runtime.jsx)(slate_react_es.KE,{ref:editor=>this.editor=editor,schema:SCHEMA,autoCorrect:!1,readOnly:this.props.disabled,onBlur:this.handleBlur,onClick:this.props.onClick,onChange:change=>{this.onChange(change.value,!1)},placeholder:this.props.placeholder,plugins:this.plugins,spellCheck:!1,value:this.state.value})})})}}const QueryField=(0,ThemeContext.cV)(UnThemedQueryField),QueryField_getStyles=theme=>{const focusStyles=(0,mixins.Hi)(theme);return{wrapper:(0,emotion_css_esm.AH)({"&:focus-within":focusStyles})}};try{UnThemedQueryField.displayName="UnThemedQueryField",UnThemedQueryField.__docgenInfo={description:"Renders an editor field.\nPass initial value as initialQuery and listen to changes in props.onValueChanged.\nThis component can only process strings. Internally it uses Slate Value.\nImplement props.onTypeahead to use suggestions, see PromQueryField.tsx as an example.",displayName:"UnThemedQueryField",props:{additionalPlugins:{defaultValue:null,description:"",name:"additionalPlugins",required:!1,type:{name:"Plugin<Editor>[]"}},cleanText:{defaultValue:null,description:"",name:"cleanText",required:!1,type:{name:"((text: string) => string)"}},disabled:{defaultValue:null,description:"",name:"disabled",required:!1,type:{name:"boolean"}},query:{defaultValue:null,description:"",name:"query",required:!1,type:{name:"string | null"}},onRunQuery:{defaultValue:null,description:"",name:"onRunQuery",required:!1,type:{name:"(() => void)"}},onBlur:{defaultValue:{value:"() => {}"},description:"",name:"onBlur",required:!1,type:{name:"(() => void)"}},onChange:{defaultValue:null,description:"",name:"onChange",required:!1,type:{name:"((value: string) => void)"}},onRichValueChange:{defaultValue:null,description:"",name:"onRichValueChange",required:!1,type:{name:"((value: Value) => void)"}},onClick:{defaultValue:null,description:"",name:"onClick",required:!1,type:{name:"EventHook<MouseEvent<Element, MouseEvent>>"}},onTypeahead:{defaultValue:null,description:"",name:"onTypeahead",required:!1,type:{name:"((typeahead: TypeaheadInput) => Promise<TypeaheadOutput>)"}},onWillApplySuggestion:{defaultValue:null,description:"",name:"onWillApplySuggestion",required:!1,type:{name:"((suggestion: string, state: SuggestionsState) => string)"}},placeholder:{defaultValue:null,description:"",name:"placeholder",required:!1,type:{name:"string"}},portalOrigin:{defaultValue:null,description:"",name:"portalOrigin",required:!0,type:{name:"string"}},syntax:{defaultValue:null,description:"",name:"syntax",required:!1,type:{name:"string"}},syntaxLoaded:{defaultValue:null,description:"",name:"syntaxLoaded",required:!1,type:{name:"boolean"}},theme:{defaultValue:null,description:"",name:"theme",required:!0,type:{name:"GrafanaTheme2"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/QueryField/QueryField.tsx#UnThemedQueryField"]={docgenInfo:UnThemedQueryField.__docgenInfo,name:"UnThemedQueryField",path:"src/components/QueryField/QueryField.tsx#UnThemedQueryField"})}catch(__react_docgen_typescript_loader_error){}try{QueryField.displayName="QueryField",QueryField.__docgenInfo={description:"",displayName:"QueryField",props:{onChange:{defaultValue:null,description:"",name:"onChange",required:!1,type:{name:"((value: string) => void)"}},onClick:{defaultValue:null,description:"",name:"onClick",required:!1,type:{name:"EventHook<MouseEvent<Element, MouseEvent>>"}},onBlur:{defaultValue:null,description:"",name:"onBlur",required:!1,type:{name:"(() => void)"}},disabled:{defaultValue:null,description:"",name:"disabled",required:!1,type:{name:"boolean"}},placeholder:{defaultValue:null,description:"",name:"placeholder",required:!1,type:{name:"string"}},additionalPlugins:{defaultValue:null,description:"",name:"additionalPlugins",required:!1,type:{name:"Plugin<Editor>[]"}},cleanText:{defaultValue:null,description:"",name:"cleanText",required:!1,type:{name:"((text: string) => string)"}},query:{defaultValue:null,description:"",name:"query",required:!1,type:{name:"string | null"}},onRunQuery:{defaultValue:null,description:"",name:"onRunQuery",required:!1,type:{name:"(() => void)"}},onRichValueChange:{defaultValue:null,description:"",name:"onRichValueChange",required:!1,type:{name:"((value: Value) => void)"}},onTypeahead:{defaultValue:null,description:"",name:"onTypeahead",required:!1,type:{name:"((typeahead: TypeaheadInput) => Promise<TypeaheadOutput>)"}},onWillApplySuggestion:{defaultValue:null,description:"",name:"onWillApplySuggestion",required:!1,type:{name:"((suggestion: string, state: SuggestionsState) => string)"}},portalOrigin:{defaultValue:null,description:"",name:"portalOrigin",required:!0,type:{name:"string"}},syntax:{defaultValue:null,description:"",name:"syntax",required:!1,type:{name:"string"}},syntaxLoaded:{defaultValue:null,description:"",name:"syntaxLoaded",required:!1,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/QueryField/QueryField.tsx#QueryField"]={docgenInfo:QueryField.__docgenInfo,name:"QueryField",path:"src/components/QueryField/QueryField.tsx#QueryField"})}catch(__react_docgen_typescript_loader_error){}const meta={title:"Inputs/Deprecated/QueryField",component:QueryField,parameters:{controls:{exclude:["onTypeahead","onChange","onBlur","onClick","onRunQuery","onRichValueChange","onWillApplySuggestion","portalOrigin","additionalPlugins","cleanText","syntax","syntaxLoaded"]}},argTypes:{query:{control:"text"}}},Basic=args=>(0,jsx_runtime.jsx)(QueryField,{...args});Basic.args={onTypeahead:async _input=>({suggestions:[]}),query:"Query text",placeholder:"Placeholder text",disabled:!1};var QueryField_story=meta;Basic.parameters={...Basic.parameters,docs:{...Basic.parameters?.docs,source:{originalSource:"(args: Omit<QueryFieldProps, 'theme'>) => <QueryField {...args} />",...Basic.parameters?.docs?.source}}}}}]);